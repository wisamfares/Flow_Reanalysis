facet_grid(Cell_Line ~ Ligand_conc)+
scale_x_log10()+
scale_y_log10()+
geom_bin2d(bins = 128)+
scale_fill_gradient(low = "blue", high = "red")
print(p)
}
analyze_bins = function(data_dir,
pSMAD2_perc_cutoff = 0.9,
HA_perc_cutoff = 0.9,
n_bins = 5,
n_boot = 1000,
is_3laser_experiment = FALSE) {
# (1) Load Data from directory
all_data = loadData(data_dir, is_3laser_experiment)
# (2) Filter Data based on pSMAD2 and HA threshold of Luc - No Cytokine
filtered_data = filterData(all_data, pSMAD2_perc_cutoff, HA_perc_cutoff)
# (3) Bin Data
binned_data = binHA(filtered_data, n_bins)
# (4) Bootstrap Binned Data
binned_boot = bootstrapBinnedData(binned_data)
# (5) Plot Binned Analysis
plotBootstrapResults(binned_boot, summ_stat = "mean")
## Supplemental Checks:
# (S1) Plot original density plots to compare to FCS Express
plotFlowDensity(all_data)
# (S2) Check Filtered Data to make sure the shape looks correct
plotFlowDensity(filtered_data)
# (S3) Dot plot of binned data
dotPlotBinData(binned_data)
list(binned_data = binned_data, binned_boot = binned_boot)
}
data_dir = "Exported Data/TGFB1/5 Laser Experiments/2024-09-04/"
results = analyze_bins(data_dir)
compareBinningParameters = function(data_dir,
pSMAD2_perc_cutoff_list = c(0.9, 0.5, 0),
HA_perc_cutoff_list = 0.9,
n_bins_list = c(5,8,10,20),
is_3laser_experiment = FALSE){
# Comparing different parameters to compare final traces
# (1) Load Data from directory
all_data = loadData(data_dir, is_3laser_experiment)
# Create a grid of all parameter combinations
param_grid <- expand.grid(
pSMAD2_perc_cutoff = pSMAD2_perc_cutoff_list,
HA_perc_cutoff = HA_perc_cutoff_list,
n_bins = n_bins_list
)
# Run the analysis for each parameter combination
agg_boot <- param_grid %>%
pmap_dfr(function(pSMAD2_perc_cutoff, HA_perc_cutoff, n_bins) {
filtered_data <- filterData(all_data, pSMAD2_perc_cutoff, HA_perc_cutoff)
binned_data   <- binHA(filtered_data, n_bins)
temp_boot     <- bootstrapBinnedData(binned_data)
# Add parameter info as columns
temp_boot %>%
mutate(
pSMAD2_perc_cutoff = pSMAD2_perc_cutoff,
HA_perc_cutoff     = HA_perc_cutoff,
n_bins             = n_bins,
binID              = as.integer(HA_bin)
)
}) %>%
mutate(param_combo = paste0("pSMAD2_", pSMAD2_perc_cutoff,
"_HA_", HA_perc_cutoff,
"_bins_", n_bins))
}
data_dir = "Exported Data/TGFB1/5 Laser Experiments/2024-09-04/"
agg_boot = compareBinningParameters(data_dir,
pSMAD2_perc_cutoff_list = c(0.9, 0.5, 0),
HA_perc_cutoff_list = 0.9,
n_bins_list = c(5,8,10,20),
is_3laser_experiment = FALSE)
agg_boot = agg_boot %>%
group_by(n_bins) %>%
mutate(normalizeBinLocation = binID/n_bins)%>%
ungroup() %>%
mutate(pSMAD2_perc_cutoff = as.factor(pSMAD2_perc_cutoff)) %>%
mutate(pSMAD2_perc_cutoff = fct_rev(pSMAD2_perc_cutoff))
for(i in unique(agg_boot$n_bins)){
temp = agg_boot %>%
filter(n_bins == i)
p = ggplot(temp, aes(x = normalizeBinLocation, y = log10(mean_pSMAD2))) +
geom_point() +
geom_errorbar(aes(ymin = log10(mean_pSMAD2_low), ymax = log10(mean_pSMAD2_high)), width = 0.02) +
facet_grid(pSMAD2_perc_cutoff ~ Ligand_conc, scales = "free", labeller = label_both )+
labs(
x = "Normalized HA (min-max)",
y = "log10(Mean pSMAD2 ± 95% CI)",
title = "Binned pSMAD2 Traces by pSMAD2 percentile cutoff and TGFB1 (ng/ml)",
subtitle = paste0("2024-09-04, (n_bins = ", i, ")")
)
print(p)
}
for(i in unique(agg_boot$pSMAD2_perc_cutoff)){
temp = agg_boot %>%
filter(pSMAD2_perc_cutoff == i)
p = ggplot(temp, aes(x = normalizeBinLocation, y = log10(mean_pSMAD2))) +
geom_point() +
geom_errorbar(aes(ymin = log10(mean_pSMAD2_low), ymax = log10(mean_pSMAD2_high)), width = 0.02) +
facet_grid(n_bins ~ Ligand_conc, scales = "free", labeller = label_both )+
labs(
x = "Normalized HA (min-max)",
y = "log10(Mean pSMAD2 ± 95% CI)",
title = "Binned pSMAD2 Traces by pSMAD2 percentile cutoff and TGFB1 (ng/ml)",
subtitle = paste0("2024-09-04, (n_bins = ", i, ")")
)
print(p)
}
loadAllData <- function(data_dir) {
# Step 1: get all experiment folders (two levels deep)
experiment_folders <- dir_ls(data_dir, recurse = 2, type = "directory")
# Step 2: filter folders that contain CSVs
experiment_folders <- experiment_folders[map_lgl(experiment_folders, ~ length(dir_ls(.x, glob = "*.csv")) > 0)]
# Step 3: map loadData over all experiment folders
all_data <- experiment_folders %>%
set_names(experiment_folders) %>%
map_dfr(~{
path <- .x
path_parts <- path_split(path)[[1]]  # split path into components
ligand <- path_parts[length(path_parts) - 2]
instrument <- path_parts[length(path_parts) - 1]
experiment <- path_parts[length(path_parts)]
is_3laser_experiment <- grepl("3 Laser", instrument)
loadData(path, is_3laser_experiment) %>%
mutate(
Instrument = instrument,
Experiment = experiment
)
})
return(all_data)
}
data_dir = "Exported Data"
all_exp_data = loadAllData(data_dir)
# For all the data, it will be ncessary to normalize the fluorescence values
# across different experiments.
# First Pass: Dividing by the pSMAD2_threshold
# -- Note: this may require some later scaling depending on the ranges
run_bootstrap_analysis_pipeline = function(data_dir,
pSMAD2_perc_cutoff = 0.9,
HA_perc_cutoff = 0.9,
n_bins = 8,
n_boot = 1000){
all_exp_data = loadAllData(data_dir)
# (2) Filter Data based on pSMAD2 and HA threshold of Luc - No Cytokine
filtered_data = all_exp_data %>%
group_by(Ligand, Experiment) %>%
## Apply filterData to each group
group_modify(~ filterData(.x, # All samples for a given ligand and experiment
pSMAD2_perc_cutoff,
HA_perc_cutoff)) %>%
ungroup()
# (3) Bin Data
binned_data = filtered_data %>%
group_by(Ligand, Experiment) %>%
group_modify(~ binHA(.x, n_bins)) %>%
ungroup()
# (4) Bootstrap Binned Data
binned_boot = binned_data %>%
group_by(Ligand, Experiment) %>%
group_modify(~bootstrapBinnedData(.x, n_boot)) %>%
ungroup()
}
data_dir = "Exported Data"
binned_boot = run_bootstrap_analysis_pipeline(data_dir,
pSMAD2_perc_cutoff = 0.75,
HA_perc_cutoff = 0.9,
n_bins = 8,
n_boot = 1000)
binned_boot = binned_boot %>%
group_by(Ligand, Experiment,Ligand_conc) %>%
arrange(HA_bin) %>%
mutate(binID = row_number()) %>%
ungroup()
for(ligand in unique(binned_boot$Ligand)){
temp = binned_boot %>%
filter(Ligand == ligand)
p = ggplot(temp, aes(x = binID, y = log10(mean_pSMAD2)))+
geom_point()+
geom_errorbar(aes(ymin = log10(mean_pSMAD2_low), ymax = log10(mean_pSMAD2_high)), width = 0.2) +
facet_grid(Experiment ~ Ligand_conc, scale = "free",
labeller = labeller(.cols = label_both))+
labs(title = ligand)
print(p)
}
data_dir = "Exported Data"
binned_boot = run_bootstrap_analysis_pipeline(data_dir,
pSMAD2_perc_cutoff = 0.75,
HA_perc_cutoff = 0.9,
n_bins = 5,
n_boot = 1000)
binned_boot = binned_boot %>%
group_by(Ligand, Experiment,Ligand_conc) %>%
arrange(HA_bin) %>%
mutate(binID = row_number()) %>%
ungroup()
for(ligand in unique(binned_boot$Ligand)){
temp = binned_boot %>%
filter(Ligand == ligand)
p = ggplot(temp, aes(x = binID, y = log10(mean_pSMAD2)))+
geom_point()+
facet_grid(Experiment ~ Ligand_conc, scale = "free",
labeller = labeller(.cols = label_both))+
geom_errorbar(aes(ymin = log10(mean_pSMAD2_low), ymax = log10(mean_pSMAD2_high)), width = 0.2) +
labs(title = ligand)
print(p)
}
# Plot with Experiments as different colors
for(ligand in unique(binned_boot$Ligand)){
temp = binned_boot %>%
filter(Ligand == ligand)
p = ggplot(temp, aes(x = binID, y = log10(mean_pSMAD2), color = Experiment))+
geom_point()+
facet_grid(~ Ligand_conc, scale = "free",
labeller = labeller(.cols = label_both))+
geom_errorbar(aes(ymin = log10(mean_pSMAD2_low), ymax = log10(mean_pSMAD2_high)), width = 0.2) +
labs(title = ligand)
print(p)
}
ggplot(binned_boot, aes(x = log10(n_cells)))+
geom_histogram()
filt_binned_boot = binned_boot %>%
filter(n_cells > 30)
ggplot(filt_binned_boot, aes(x = log10(n_cells)))+
geom_histogram()
for(ligand in unique(filt_binned_boot$Ligand)){
temp = filt_binned_boot %>%
filter(Ligand == ligand)
p = ggplot(temp, aes(x = binID, y = log10(mean_pSMAD2)))+
geom_point()+
facet_grid(Experiment ~ Ligand_conc, scale = "free",
labeller = labeller(.cols = label_both))+
geom_errorbar(aes(ymin = log10(mean_pSMAD2_low), ymax = log10(mean_pSMAD2_high)), width = 0.2) +
labs(title = ligand)
print(p)
}
# Normalizing pSMAd Expression
norm_binned_boot = binned_boot %>%
group_by(Ligand,Experiment) %>%
mutate(control_mean = mean_pSMAD2[Ligand_conc == 0 & binID == 1],
control_max = max(mean_pSMAD2)) %>%
mutate(norm_mean = (mean_pSMAD2 - control_mean) / (control_max - control_mean) ,
norm_mean_low = (mean_pSMAD2_low - control_mean)/ (control_max - control_mean),
norm_mean_high = (mean_pSMAD2_high - control_mean)/ (control_max - control_mean)
) %>%
mutate(control_median = median_pSMAD2[Ligand_conc == 0 & binID == 1],
control_median_max = max(median_pSMAD2)) %>%
mutate(norm_median = (median_pSMAD2 - control_median) / (control_median_max - control_median),
norm_median_low = (median_pSMAD2_low - control_median)/ (control_median_max - control_median),
norm_median_high = (median_pSMAD2_high - control_median)/ (control_median_max - control_median)) %>%
ungroup()
for (ligand in unique(norm_binned_boot$Ligand)){
temp = norm_binned_boot %>%
filter(Ligand == ligand)
p = ggplot(temp, aes(x = binID, y = norm_mean, color = Experiment))+
geom_point()+
facet_grid(~ Ligand_conc,
labeller = labeller(.cols = label_both))+
labs(title = ligand)
print(p)
}
for (ligand in unique(norm_binned_boot$Ligand)){
temp = norm_binned_boot %>%
filter(Ligand == ligand)
p = ggplot(temp, aes(x = binID, y = norm_mean))+
geom_point()+
facet_grid(Experiment ~ Ligand_conc,
labeller = labeller(.cols = label_both))+
geom_errorbar(aes(ymin = norm_mean_low, ymax = norm_mean_high), width = 0.2) +
labs(title = ligand)
print(p)
}
data_dir = "Exported Data"
binned_boot = run_bootstrap_analysis_pipeline(data_dir,
pSMAD2_perc_cutoff = 0.9,
HA_perc_cutoff = 0.9,
n_bins = 4,
n_boot = 1000)
binned_boot = binned_boot %>%
group_by(Ligand, Experiment,Ligand_conc) %>%
arrange(HA_bin) %>%
mutate(binID = row_number()) %>%
ungroup()
for(ligand in unique(binned_boot$Ligand)){
temp = binned_boot %>%
filter(Ligand == ligand)
p = ggplot(temp, aes(x = binID, y = log10(mean_pSMAD2)))+
geom_point()+
facet_grid(Experiment ~ Ligand_conc, scale = "free",
labeller = labeller(.cols = label_both))+
geom_errorbar(aes(ymin = log10(mean_pSMAD2_low), ymax = log10(mean_pSMAD2_high)), width = 0.2) +
labs(title = ligand)
print(p)
}
# Plot with Experiments as different colors
for(ligand in unique(binned_boot$Ligand)){
temp = binned_boot %>%
filter(Ligand == ligand)
p = ggplot(temp, aes(x = binID, y = log10(mean_pSMAD2), color = Experiment))+
geom_point()+
facet_grid(~ Ligand_conc, scale = "free",
labeller = labeller(.cols = label_both))+
geom_errorbar(aes(ymin = log10(mean_pSMAD2_low), ymax = log10(mean_pSMAD2_high)), width = 0.2) +
labs(title = ligand)
print(p)
}
# Normalizing pSMAD Expression
norm_binned_boot = binned_boot %>%
group_by(Ligand,Experiment) %>%
mutate(control_mean = mean_pSMAD2[Ligand_conc == 0 & binID == 1],
control_max = max(mean_pSMAD2)) %>%
mutate(norm_mean = (mean_pSMAD2 - control_mean) / (control_max - control_mean) ,
norm_mean_low = (mean_pSMAD2_low - control_mean)/ (control_max - control_mean),
norm_mean_high = (mean_pSMAD2_high - control_mean)/ (control_max - control_mean)
) %>%
mutate(control_median = median_pSMAD2[Ligand_conc == 0 & binID == 1],
control_median_max = max(median_pSMAD2)) %>%
mutate(norm_median = (median_pSMAD2 - control_median) / (control_median_max - control_median),
norm_median_low = (median_pSMAD2_low - control_median)/ (control_median_max - control_median),
norm_median_high = (median_pSMAD2_high - control_median)/ (control_median_max - control_median)) %>%
ungroup()
for (ligand in unique(norm_binned_boot$Ligand)){
temp = norm_binned_boot %>%
filter(Ligand == ligand)
p = ggplot(temp, aes(x = binID, y = norm_mean, color = Experiment))+
geom_point()+
facet_grid(~ Ligand_conc,
labeller = labeller(.cols = label_both))+
labs(title = ligand)
print(p)
}
for (ligand in unique(norm_binned_boot$Ligand)){
temp = norm_binned_boot %>%
filter(Ligand == ligand)
p = ggplot(temp, aes(x = binID, y = norm_mean))+
geom_point()+
facet_grid(Experiment ~ Ligand_conc,
labeller = labeller(.cols = label_both))+
geom_errorbar(aes(ymin = norm_mean_low, ymax = norm_mean_high), width = 0.2) +
labs(title = ligand)
print(p)
}
data_dir = "Exported Data"
binned_boot = run_bootstrap_analysis_pipeline(data_dir,
pSMAD2_perc_cutoff = 0.75,
HA_perc_cutoff = 0.9,
n_bins = 8,
n_boot = 1000)
binned_boot = binned_boot %>%
filter(n_cells > 30) %>%
group_by(Ligand, Experiment,Ligand_conc) %>%
arrange(HA_bin) %>%
mutate(binID = row_number()) %>%
ungroup()
for(ligand in unique(binned_boot$Ligand)){
temp = binned_boot %>%
filter(Ligand == ligand)
p = ggplot(temp, aes(x = binID, y = log10(mean_pSMAD2)))+
geom_point()+
facet_grid(Experiment ~ Ligand_conc, scale = "free",
labeller = labeller(.cols = label_both))+
geom_errorbar(aes(ymin = log10(mean_pSMAD2_low), ymax = log10(mean_pSMAD2_high)), width = 0.2) +
labs(title = ligand)
print(p)
}
# Plot with Experiments as different colors
for(ligand in unique(binned_boot$Ligand)){
temp = binned_boot %>%
filter(Ligand == ligand)
p = ggplot(temp, aes(x = binID, y = log10(mean_pSMAD2), color = Experiment))+
geom_point()+
facet_grid(~ Ligand_conc, scale = "free",
labeller = labeller(.cols = label_both))+
geom_errorbar(aes(ymin = log10(mean_pSMAD2_low), ymax = log10(mean_pSMAD2_high)), width = 0.2) +
labs(title = ligand)
print(p)
}
# 2025-11-13 --> Different binning parameters for pSMAD2 threshold for all samples
data_dir = "Exported Data"
pSMAD2_perc_cutoff = 0.9
binned_boot = run_bootstrap_analysis_pipeline(data_dir,
pSMAD2_perc_cutoff = pSMAD2_perc_cutoff,
HA_perc_cutoff = 0.9,
n_bins = 8,
n_boot = 1000)
binned_boot = binned_boot %>%
group_by(Ligand, Experiment,Ligand_conc) %>%
arrange(HA_bin) %>%
mutate(binID = row_number()) %>%
ungroup()
for(ligand in unique(binned_boot$Ligand)){
temp = binned_boot %>%
filter(Ligand == ligand)
p = ggplot(temp, aes(x = binID, y = log10(mean_pSMAD2)))+
geom_point()+
facet_grid(Experiment ~ Ligand_conc, scale = "free",
labeller = labeller(.cols = label_both))+
geom_errorbar(aes(ymin = log10(mean_pSMAD2_low), ymax = log10(mean_pSMAD2_high)), width = 0.2) +
labs(title = ligand)
print(p)
}
# Plot with Experiments as different colors
for(ligand in unique(binned_boot$Ligand)){
temp = binned_boot %>%
filter(Ligand == ligand)
p = ggplot(temp, aes(x = binID, y = log10(mean_pSMAD2), color = Experiment))+
geom_point()+
facet_grid(~ Ligand_conc, scale = "free",
labeller = labeller(.cols = label_both))+
geom_errorbar(aes(ymin = log10(mean_pSMAD2_low), ymax = log10(mean_pSMAD2_high)), width = 0.2) +
labs(title = paste(ligand, ", pSMAD2_perc_cutoff =", pSMAD2_perc_cutoff)
print(p)
for(ligand in unique(binned_boot$Ligand)){
temp = binned_boot %>%
filter(Ligand == ligand)
p = ggplot(temp, aes(x = binID, y = log10(mean_pSMAD2)))+
geom_point()+
facet_grid(Experiment ~ Ligand_conc, scale = "free",
labeller = labeller(.cols = label_both))+
geom_errorbar(aes(ymin = log10(mean_pSMAD2_low), ymax = log10(mean_pSMAD2_high)), width = 0.2) +
labs(title = paste0(ligand, ", pSMAD2_perc_cutoff = ", pSMAD2_perc_cutoff))
print(p)
}
# Plot with Experiments as different colors
for(ligand in unique(binned_boot$Ligand)){
temp = binned_boot %>%
filter(Ligand == ligand)
p = ggplot(temp, aes(x = binID, y = log10(mean_pSMAD2), color = Experiment))+
geom_point()+
facet_grid(~ Ligand_conc, scale = "free",
labeller = labeller(.cols = label_both))+
geom_errorbar(aes(ymin = log10(mean_pSMAD2_low), ymax = log10(mean_pSMAD2_high)), width = 0.2) +
labs(title = paste0(ligand, ", pSMAD2_perc_cutoff = ", pSMAD2_perc_cutoff))
print(p)
}
# 2025-11-13 --> Different binning parameters for pSMAD2 threshold for all samples
data_dir = "Exported Data"
pSMAD2_perc_cutoff_list = c(0.9, 0.5, 0.1)
for (pSMAD2_perc_cutoff in pSMAD2_perc_cutoff_list){
binned_boot = run_bootstrap_analysis_pipeline(data_dir,
pSMAD2_perc_cutoff = pSMAD2_perc_cutoff,
HA_perc_cutoff = 0.9,
n_bins = 8,
n_boot = 1000)
binned_boot = binned_boot %>%
group_by(Ligand, Experiment,Ligand_conc) %>%
arrange(HA_bin) %>%
mutate(binID = row_number()) %>%
ungroup()
for(ligand in unique(binned_boot$Ligand)){
temp = binned_boot %>%
filter(Ligand == ligand)
p = ggplot(temp, aes(x = binID, y = log10(mean_pSMAD2)))+
geom_point()+
facet_grid(Experiment ~ Ligand_conc, scale = "free",
labeller = labeller(.cols = label_both))+
geom_errorbar(aes(ymin = log10(mean_pSMAD2_low), ymax = log10(mean_pSMAD2_high)), width = 0.2) +
labs(title = paste0(ligand, ", pSMAD2_perc_cutoff = ", pSMAD2_perc_cutoff))
print(p)
}
# Plot with Experiments as different colors
for(ligand in unique(binned_boot$Ligand)){
temp = binned_boot %>%
filter(Ligand == ligand)
p = ggplot(temp, aes(x = binID, y = log10(mean_pSMAD2), color = Experiment))+
geom_point()+
facet_grid(~ Ligand_conc, scale = "free",
labeller = labeller(.cols = label_both))+
geom_errorbar(aes(ymin = log10(mean_pSMAD2_low), ymax = log10(mean_pSMAD2_high)), width = 0.2) +
labs(title = paste0(ligand, ", pSMAD2_perc_cutoff = ", pSMAD2_perc_cutoff))
print(p)
}
}
# 5 Bins -- Same analysis as above
data_dir = "Exported Data"
pSMAD2_perc_cutoff_list = c(0.9, 0.5, 0.1)
for (pSMAD2_perc_cutoff in pSMAD2_perc_cutoff_list){
binned_boot = run_bootstrap_analysis_pipeline(data_dir,
pSMAD2_perc_cutoff = pSMAD2_perc_cutoff,
HA_perc_cutoff = 0.9,
n_bins = 5,
n_boot = 1000)
binned_boot = binned_boot %>%
group_by(Ligand, Experiment,Ligand_conc) %>%
arrange(HA_bin) %>%
mutate(binID = row_number()) %>%
ungroup()
for(ligand in unique(binned_boot$Ligand)){
temp = binned_boot %>%
filter(Ligand == ligand)
p = ggplot(temp, aes(x = binID, y = log10(mean_pSMAD2)))+
geom_point()+
facet_grid(Experiment ~ Ligand_conc, scale = "free",
labeller = labeller(.cols = label_both))+
geom_errorbar(aes(ymin = log10(mean_pSMAD2_low), ymax = log10(mean_pSMAD2_high)), width = 0.2) +
labs(title = paste0(ligand, ", pSMAD2_perc_cutoff = ", pSMAD2_perc_cutoff))
print(p)
}
# Plot with Experiments as different colors
for(ligand in unique(binned_boot$Ligand)){
temp = binned_boot %>%
filter(Ligand == ligand)
p = ggplot(temp, aes(x = binID, y = log10(mean_pSMAD2), color = Experiment))+
geom_point()+
facet_grid(~ Ligand_conc, scale = "free",
labeller = labeller(.cols = label_both))+
geom_errorbar(aes(ymin = log10(mean_pSMAD2_low), ymax = log10(mean_pSMAD2_high)), width = 0.2) +
labs(title = paste0(ligand, ", pSMAD2_perc_cutoff = ", pSMAD2_perc_cutoff))
print(p)
}
}
setwd("Z:/Wisam/Flow_Analysis")
