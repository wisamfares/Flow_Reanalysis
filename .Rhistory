}
data_dir = "Exported Data"
binned_boot = run_bootstrap_analysis_pipeline(data_dir,
pSMAD2_perc_cutoff = 0.75,
HA_perc_cutoff = 0.1,
n_bins = 8,
n_boot = 1000)
binned_boot = binned_boot %>%
group_by(Ligand, Experiment,Ligand_conc) %>%
arrange(HA_bin) %>%
mutate(binID = row_number()) %>%
ungroup()
for(ligand in unique(binned_boot$Ligand)){
temp = binned_boot %>%
filter(Ligand == ligand)
p = ggplot(temp, aes(x = binID, y = mean_Norm_pSMAD2)))+
for(ligand in unique(binned_boot$Ligand)){
temp = binned_boot %>%
filter(Ligand == ligand)
p = ggplot(temp, aes(x = binID, y = mean_Norm_pSMAD2))+
geom_point()+
geom_errorbar(aes(ymin = mean_Norm_pSMAD2_low, ymax = mean_Norm_pSMAD2_high), width = 0.2) +
facet_grid(Experiment ~ Ligand_conc, scale = "free",
labeller = labeller(.cols = label_both))+
labs(title = ligand)
print(p)
}
# Plot with Experiments as different colors
for(ligand in unique(binned_boot$Ligand)){
temp = binned_boot %>%
filter(Ligand == ligand)
p = ggplot(temp, aes(x = binID, y = log10(mean_pSMAD2), color = Experiment))+
geom_point()+
facet_grid(~ Ligand_conc, scale = "free",
labeller = labeller(.cols = label_both))+
geom_errorbar(aes(ymin = log10(mean_pSMAD2_low), ymax = log10(mean_pSMAD2_high)), width = 0.2) +
labs(title = ligand)
print(p)
}
for(ligand in unique(binned_boot$Ligand)){
temp = binned_boot %>%
filter(Ligand == ligand)
p = ggplot(temp, aes(x = binID, y = (mean_Norm_pSMAD2)))+
geom_point()+
facet_grid(Experiment ~ Ligand_conc, scale = "free",
labeller = labeller(.cols = label_both))+
geom_errorbar(aes(ymin = (mean_Norm_pSMAD2_low), ymax = (mean_Norm_pSMAD2_high)), width = 0.2) +
labs(title = ligand)
print(p)
}
# Plot with Experiments as different colors
for(ligand in unique(binned_boot$Ligand)){
temp = binned_boot %>%
filter(Ligand == ligand)
p = ggplot(temp, aes(x = binID, y = (mean_Norm_pSMAD2), color = Experiment))+
geom_point()+
facet_grid(~ Ligand_conc, scale = "free",
labeller = labeller(.cols = label_both))+
geom_errorbar(aes(ymin = (mean_Norm_pSMAD2_low), ymax = (mean_Norm_pSMAD2_high)), width = 0.2) +
labs(title = ligand)
print(p)
}
data_dir = "Exported Data"
binned_boot = run_bootstrap_analysis_pipeline(data_dir,
pSMAD2_perc_cutoff = 0.5,
HA_perc_cutoff = 0.1,
n_bins = 8,
n_boot = 1000)
binned_boot = binned_boot %>%
group_by(Ligand, Experiment,Ligand_conc) %>%
arrange(HA_bin) %>%
mutate(binID = row_number()) %>%
ungroup()
for(ligand in unique(binned_boot$Ligand)){
temp = binned_boot %>%
filter(Ligand == ligand)
p = ggplot(temp, aes(x = binID, y = mean_Norm_pSMAD2))+
geom_point()+
geom_errorbar(aes(ymin = mean_Norm_pSMAD2_low, ymax = mean_Norm_pSMAD2_high), width = 0.2) +
facet_grid(Experiment ~ Ligand_conc, scale = "free",
labeller = labeller(.cols = label_both))+
labs(title = ligand)
print(p)
}
for(ligand in unique(binned_boot$Ligand)){
temp = binned_boot %>%
filter(Ligand == ligand)
p = ggplot(temp, aes(x = binID, y = (mean_Norm_pSMAD2)))+
geom_point()+
facet_grid(Experiment ~ Ligand_conc, scale = "free",
labeller = labeller(.cols = label_both))+
geom_errorbar(aes(ymin = (mean_Norm_pSMAD2_low), ymax = (mean_Norm_pSMAD2_high)), width = 0.2) +
labs(title = ligand)
print(p)
}
# Plot with Experiments as different colors
for(ligand in unique(binned_boot$Ligand)){
temp = binned_boot %>%
filter(Ligand == ligand)
p = ggplot(temp, aes(x = binID, y = (mean_Norm_pSMAD2), color = Experiment))+
geom_point()+
facet_grid(~ Ligand_conc, scale = "free",
labeller = labeller(.cols = label_both))+
geom_errorbar(aes(ymin = (mean_Norm_pSMAD2_low), ymax = (mean_Norm_pSMAD2_high)), width = 0.2) +
labs(title = ligand)
print(p)
}
head(binned_boot)
library(tidyverse)
library(fs)
## Analysis Pipeline Functions
loadData = function(data_dir){
# Loads all samples from a given experiment into a single data frame
# Cleans up data by selecting Norm_pSMAD2 and HA columns, and removing outliers
# Outliers removed by filtering to 0.1 - 99.9 percentiles
# Load Data
csv_files <- list.files(path = data_dir, pattern = "\\.csv$", full.names = TRUE)
# Define old colnames
old_HA_colname = "B1-A"
old_pSMAD2_colname = "YG1-A"
old_SMAD2_colname = "R2-A"
all_data <- csv_files %>%
set_names(basename(csv_files)) %>%  # optional: name each element by file name
map_dfr(~read_csv(.x, show_col_types = FALSE), .id = "Sample_Name") %>% # read each file and combine, keep filename
mutate(Sample_Name = str_replace(Sample_Name, ".csv", "")) %>% # Remove .csv from Sample_Name name
# Extract Cell Name
separate(Sample_Name, into = c("Cell_Line", "Dox", "Ligand", "Replicate"), sep = "_", fill = "right", remove = FALSE) %>%
mutate(Dox = case_when(
Dox == "pD" ~ "+dox",
Dox == "mD" ~ "-dox",
TRUE ~ "Error"
)
) %>%
mutate(
Ligand_conc = case_when(
Ligand == "mC" ~ 0,
grepl("^[0-9.]+[TG]$", Ligand) ~ as.numeric(sub("[TG]$", "", Ligand)),
TRUE ~ -1
)
) %>%
mutate(Ligand = case_when(
grepl("T", Ligand) ~ "TGFB1",
grepl("G", Ligand) ~ "GDF11",
grepl("mC", Ligand) ~ "No Cyto",
TRUE ~ "Error"
)
) %>%
mutate(Replicate = str_extract(Replicate, "\\d+$"),
Replicate = as.integer(Replicate),
Replicate = case_when(
is.na(Replicate) ~ 1,
TRUE ~ Replicate
)
) %>%
# Clean up data frame
relocate(Sample_Name, Cell_Line, Ligand, Ligand_conc) %>%
# (2) Filter to only include columns of interest, B1.A and YG1.A for 5 laser, HA and pSMAD for 3 laser
select("Sample_Name", "Cell_Line", "Dox", "Ligand", "Ligand_conc", "Replicate", contains("FSC-A"),
starts_with(old_HA_colname),
starts_with(old_pSMAD2_colname),
starts_with(old_SMAD2_colname)) %>%
rename_with(~ "HA", starts_with(old_HA_colname))%>%
rename_with(~ "pSMAD2", starts_with(old_pSMAD2_colname)) %>%
rename_with(~ "SMAD2", starts_with(old_SMAD2_colname)) %>%
## Log Transform HA and Norm_pSMAD2
mutate(
pSMAD2 = log10(pSMAD2),
HA = log10(HA),
SMAD2 = log10(SMAD2)
) %>%
drop_na() %>% # Remove NAs
## Filter outliers
group_by(Cell_Line, Ligand, Ligand_conc) %>%
# calculate the quantiles for Norm_pSMAD2 and HA
mutate(
p001_pSMAD2 = quantile(pSMAD2, 0.001),
p999_pSMAD2 = quantile(pSMAD2, 0.999),
p001_HA = quantile(HA, 0.001),
p999_HA = quantile(HA, 0.999)
) %>%
# Keep only rows within the 0.1-99.9 percentile
filter(pSMAD2 >= p001_pSMAD2,
pSMAD2 <= p999_pSMAD2,
HA >= p001_HA,
HA <= p999_HA) %>%
ungroup() %>%
select(-p001_pSMAD2, -p999_pSMAD2, -p001_HA, -p999_HA) %>% # Remove percentile columns
mutate(Norm_pSMAD2 = pSMAD2/SMAD2)
return(all_data)
}
filterData = function(all_data,
Norm_pSMAD2_perc_cutoff = 0,
HA_perc_cutoff){
# Uses perc_cutoffs to determine thresholds from Luc - No Cyto sample
# Calculate threshold based on -dox, -cyto condition
Norm_pSMAD2_thresh = all_data %>%
filter(Dox == "-dox",
Ligand == "No Cyto") %>%
summarize(p_Norm_pSMAD2 = quantile(Norm_pSMAD2, Norm_pSMAD2_perc_cutoff)) %>%
pull(p_Norm_pSMAD2)
HA_thresh = all_data %>%
filter(Dox == "-dox",
Ligand == "No Cyto") %>%
summarize(p_HA = quantile(HA, HA_perc_cutoff)) %>%
pull(p_HA)
# Use thresholds to filter data
filtered_data = all_data %>%
filter(Cell_Line == "R3") %>%
filter(Norm_pSMAD2 > !!Norm_pSMAD2_thresh) %>%
filter(HA > !!HA_thresh)
return(filtered_data)
}
binHA = function(filtered_data, n_bins){
# Bin HA data based off n_bins using previous HA_perc cutoff (new min) and max HA
# Calculate min and max HA
filt_data_summ = filtered_data %>%
summarize(min_HA = min(HA),
max_HA = max(HA),
# Adding 90p to prevent bins with low numbers of cells
p_HA = quantile(HA, 0.95))
# Pull min and max from summary
min_HA = pull(filt_data_summ, min_HA)
max_HA = pull(filt_data_summ, max_HA)
p_HA = pull(filt_data_summ, p_HA)
# Create bin edges
bins = seq(min_HA-1e-1, max_HA+1e-1, length.out = n_bins + 1) # Log spaced bin edges
# Use bins to cut data
